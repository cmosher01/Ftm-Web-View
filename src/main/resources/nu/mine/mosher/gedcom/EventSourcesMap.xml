<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nu.mine.mosher.gedcom.EventSourcesMap">
    <resultMap id="mapEventWithSources" type="nu.mine.mosher.gedcom.EventWithSources" autoMapping="true">
        <id column="pkidFact" property="pkidFact"/>
        <collection property="sources" ofType="nu.mine.mosher.gedcom.EventSource" autoMapping="false" notNullColumn="pkidCitation">
            <id property="pkidSourceLink" column="pkidSourceLink"/>
            <result property="stars" column="stars"/>
            <result property="just" column="just"/>
            <result property="pkidCitation" column="pkidCitation"/>
            <result property="page" column="page"/>
            <result property="comment" column="comment"/>
            <result property="footnote" column="footnote"/>
            <result property="apid" column="apid"/>
            <result property="author" column="author"/>
            <result property="title" column="title"/>
            <result property="placePub" column="placePub"/>
            <result property="pub" column="pub"/>
            <result property="datePub" column="datePub"/>
            <result property="callno" column="callno"/>
            <result property="source" column="source"/>
            <result property="apidSource" column="apidSource"/>
            <collection property="media" columnPrefix="media_" ofType="nu.mine.mosher.gedcom.MediaFile" autoMapping="true" notNullColumn="pkidMedia">
                <id property="pkidMedia" column="pkidMedia"/>
            </collection>
        </collection>
    </resultMap>
    <!-- TODO add WebLinks -->
    <select id="select" resultMap="mapEventWithSources" parameterType="nu.mine.mosher.gedcom.FtmLink">
        SELECT
            Fact.ID AS pkidFact,
            SourceLink.ID AS pkidSourceLink,
            SourceLink.Stars AS stars,
            SourceLink.Justification AS just,
            Source.ID AS pkidCitation,
            Source.PageNumber AS page,
            Source.Comment AS comment,
            Source.Footnote AS footnote,
            Source.PID AS apid,
            MasterSource.Author AS author,
            MasterSource.Title AS title,
            MasterSource.PublisherLocation AS placePub,
            MasterSource.PublisherName AS pub,
            MasterSource.PublishDate AS datePub,
            MasterSource.CallNumber AS callno,
            MasterSource.Comments AS source,
            MasterSource.PID AS apidSource,
            MediaFile.ID AS media_pkidMedia,
            MediaFile.FileName AS media_file
        FROM
            Fact LEFT OUTER JOIN
            SourceLink ON (SourceLink.LinkTableID = 2 AND SourceLink.LinkID = Fact.ID) LEFT OUTER JOIN
            Source ON Source.ID = SourceLink.SourceID LEFT OUTER JOIN
            MasterSource ON MasterSource.ID = Source.MasterSourceID LEFT OUTER JOIN
            MediaLink ON MediaLink.LinkTableID = 16 AND MediaLink.LinkID = Source.ID LEFT OUTER JOIN
            MediaFile ON MediaFile.ID = MediaLink.MediaFileID
        WHERE
            Fact.LinkTableID = #{table.id} AND
            Fact.LinkID = #{id}

        UNION ALL

        SELECT
            Fact.ID AS pkidFact,
            SourceLink.ID AS pkidSourceLink,
            SourceLink.Stars AS stars,
            SourceLink.Justification AS just,
            Source.ID AS pkidCitation,
            Source.PageNumber AS page,
            Source.Comment AS comment,
            Source.Footnote AS footnote,
            Source.PID AS apid,
            MasterSource.Author AS author,
            MasterSource.Title AS title,
            MasterSource.PublisherLocation AS placePub,
            MasterSource.PublisherName AS pub,
            MasterSource.PublishDate AS datePub,
            MasterSource.CallNumber AS callno,
            MasterSource.Comments AS source,
            MasterSource.PID AS apidSource,
            MediaFile.ID AS media_pkidMedia,
            MediaFile.FileName AS media_file
        FROM
            Fact LEFT OUTER JOIN
            SourceLink ON (SourceLink.LinkTableID = 2 AND SourceLink.LinkID = Fact.ID) LEFT OUTER JOIN
            Source ON Source.ID = SourceLink.SourceID LEFT OUTER JOIN
            MasterSource ON MasterSource.ID = Source.MasterSourceID LEFT OUTER JOIN
            MediaLink ON MediaLink.LinkTableID = 10 AND MediaLink.LinkID = MasterSource.ID LEFT OUTER JOIN
            MediaFile ON MediaFile.ID = MediaLink.MediaFileID
        WHERE
            Fact.LinkTableID = #{table.id} AND
            Fact.LinkID = #{id}

        UNION ALL

        SELECT
            Fact.ID AS pkidFact,
            0 AS pkidSourceLink,
            null AS stars,
            null AS just,
            random() AS pkidCitation,
            null AS page,
            null AS comment,
            null AS footnote,
            null AS apid,
            null AS author,
            'unknown source' AS title,
            null AS placePub,
            null AS pub,
            null AS datePub,
            null AS callno,
            null AS source,
            null AS apidSource,
            MediaFile.ID AS media_pkidMedia,
            MediaFile.FileName AS media_file
        FROM
            Fact LEFT OUTER JOIN
            MediaLink ON MediaLink.LinkTableID = 2 AND MediaLink.LinkID = Fact.ID LEFT OUTER JOIN
            MediaFile ON MediaFile.ID = MediaLink.MediaFileID
        WHERE
            Fact.LinkTableID = #{table.id} AND
            Fact.LinkID = #{id} AND
            MediaFile.ID IS NOT NULL

        ORDER BY
            pkidFact
    </select>
</mapper>
