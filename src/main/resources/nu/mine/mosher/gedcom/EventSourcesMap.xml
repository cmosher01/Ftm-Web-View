<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nu.mine.mosher.gedcom.EventSourcesMap">
    <resultMap id="mapEventWithSources" type="nu.mine.mosher.gedcom.EventWithSources" autoMapping="true">
        <id column="pkidFact" property="pkidFact"/>
        <collection property="sources" ofType="nu.mine.mosher.gedcom.EventSource" autoMapping="true" notNullColumn="pkidCitation">
            <id property="pkidSourceLink" column="pkidSourceLink"/>
        </collection>
    </resultMap>
    <select id="select" resultMap="mapEventWithSources" parameterType="nu.mine.mosher.gedcom.FtmLink" resultOrdered="true">
        SELECT
            Fact.ID AS pkidFact,
            SourceLink.ID AS pkidSourceLink,
            SourceLink.ExternalID AS apid,
            SourceLink.Stars AS stars,
            SourceLink.Justification AS just,
            Source.ID AS pkidCitation,
            Source.PageNumber AS page,
            Source.Comment AS comment,
            Source.Footnote AS footnote,
            Source.PID AS apidCitation,
            MasterSource.Author AS author,
            MasterSource.Title AS title,
            MasterSource.PublisherLocation AS placePub,
            MasterSource.PublisherName AS pub,
            MasterSource.PublishDate AS datePub,
            MasterSource.CallNumber AS callno,
            MasterSource.Comments AS source,
            MasterSource.PID AS apidSource,
            MasterSource.TemplateData AS template
        FROM
            Fact LEFT OUTER JOIN
            SourceLink ON (SourceLink.LinkTableID = 2 AND SourceLink.LinkID = Fact.ID) LEFT OUTER JOIN
            Source ON Source.ID = SourceLink.SourceID LEFT OUTER JOIN
            MasterSource ON MasterSource.ID = Source.MasterSourceID
        WHERE
            Fact.LinkTableID = #{table.id} AND
            Fact.LinkID = #{id}
        ORDER BY
            pkidFact
    </select>
</mapper>
