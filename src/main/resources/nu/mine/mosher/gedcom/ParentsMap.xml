<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nu.mine.mosher.gedcom.ParentsMap">
    <resultMap id="parent_result" type="nu.mine.mosher.gedcom.PersonParent" autoMapping="false">
        <constructor>
            <idArg column="id" javaType="java.util.UUID"/>
            <arg column="name" javaType="String"/>
            <arg column="nature" javaType="_int"/>
        </constructor>
    </resultMap>

    <resultMap id="result" type="nu.mine.mosher.gedcom.FullPerson" autoMapping="false">
        <id column="id" property="id"/>
        <result column="nameWithSlashes" property="nameWithSlashes"/>
        <collection property="parents" columnPrefix="parent_" resultMap="parent_result"/>
    </resultMap>



    <select id="select" resultMap="result" parameterType="nu.mine.mosher.gedcom.IndexedPerson" resultOrdered="true">
        WITH Param AS (
            SELECT ID as PersonID FROM Person WHERE PersonGUID = #{id}
        )

        SELECT
            Child.PersonGUID as id,
            Child.FullNameReversed as nameWithSlashes,
            Person.PersonGUID as parent_id, -- TODO get REFN if available
            Person.FullNameReversed as parent_name,
            ChildRelationship.Nature1 AS parent_nature -- note: nature 1
            --Relationship.Private AS prvt_parent,
            --ChildRelationship.Private AS prvt_child,
            --ChildRelationship.Preferred AS pref
        FROM
            Param LEFT OUTER JOIN
            Person AS Child ON (Child.ID = Param.PersonID) LEFT OUTER JOIN
            ChildRelationship ON (ChildRelationship.PersonID = Param.PersonID) LEFT OUTER JOIN
            Relationship ON (Relationship.ID = ChildRelationship.RelationshipID) LEFT OUTER JOIN
            Person ON (Person.ID = Relationship.Person1ID) -- note: parent 1

        UNION ALL

        SELECT
            Child.PersonGUID as id,
            Child.FullNameReversed as nameWithSlashes,
            Person.PersonGUID as parent_id,
            Person.FullNameReversed as parent_name,
            ChildRelationship.Nature2 as parent_nature -- note: nature 2
            --Relationship.Private,
            --ChildRelationship.Private,
            --ChildRelationship.Preferred
        FROM
            Param LEFT OUTER JOIN
            Person AS Child ON (Child.ID = Param.PersonID) LEFT OUTER JOIN
            ChildRelationship ON (ChildRelationship.PersonID = Param.PersonID) LEFT OUTER JOIN
            Relationship ON (Relationship.ID = ChildRelationship.RelationshipID) LEFT OUTER JOIN
            Person ON (Person.ID = Relationship.Person2ID) -- note: parent 2

        ORDER BY
            id
    </select>
</mapper>
